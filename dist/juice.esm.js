/* @pollon/juice - v1.0.0
* https://github.com/pollon-js/juice#readme
* 2020 Francesco Lasaracina. Licensed ISC */
import{Application as t,TemplateLoader as e}from"@pollon/pollon";import{Command as n,findBehaviour as r,Behaviour as o}from"@pollon/juice-lang";import{Subscriber as a}from"@pollon/message-broker";import{StateMachine as i}from"@pollon/state-machine";import{Query as c}from"@pollon/light-dom";function l(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function u(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function s(t,e,n){return e&&u(t.prototype,e),n&&u(t,n),t}function f(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&m(t,e)}function h(t){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function m(t,e){return(m=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function p(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function d(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=h(t);if(e){var o=h(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return p(this,n)}}function y(t,e,n){return(y="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var r=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=h(t)););return t}(t,e);if(r){var o=Object.getOwnPropertyDescriptor(r,e);return o.get?o.get.call(n):o.value}})(t,e,n||t)}var v=function(e,n){var o,a,i,c,l,u;if(n.shift(),2!=(o=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Lifecycle Command";if(!(a=t.get(o[0])))throw"Pollon Lifecycle Command: app ".concat(o[0]," does not exist");switch(i=n.shift()){case"initialized":c="moduleInitialized";break;case"loaded":c="moduleLoaded";break;case"ready":c="moduleReady";break;case"disposed":c="moduleDisposed"}return u=n.shift(),l=r(u),a[c].subscribe((function(t,e){var n;e.module==o[1]&&("initialized"!=i&&(n=document.querySelector('[data-view="'.concat(e.module,'"]'))),l.execute(u,n))})),!0},g=function(t){f(r,n);var e=d(r);function r(t){var n;return l(this,r),(n=e.call(this,"Pollon.Lifecycle",'when module "([^"]+)" is (initialized|loaded|ready|disposed) (.*)',(function(){}))).strategy=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return v.apply(this,[t].concat(n))},n}return r}(),w=function(e,n){var o,i,c,l,u;if(n.shift(),2!=(o=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Events Command";if(!(i=t.get(o[0])))throw"Pollon Events Command: app ".concat(o[0]," does not exist");return u=n.shift(),l=r(u),(c={})[o[1]]={method:function(t,e){var n;n=document.querySelector("[pollon-app]"),l.execute(u,n)},once:!1},i.Bus.add(new a(c)),!0},P=function(t){f(r,n);var e=d(r);function r(t){var n;return l(this,r),(n=e.call(this,"Pollon.Events",'when pollon emits "([^"]+)" (.*)',(function(){}))).strategy=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return w.apply(this,[t].concat(n))},n}return r}(),b=function(e,n){var r,o,a;if(n.shift(),!(o=n.shift()))throw"Pollon Import Partial Command: invalid partial name";if(2!=(r=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Import Partial Command";if(!(a=t.get(r[0])))throw"Pollon Import Partial Command: app ".concat(r[0]," does not exist");if(!a.Templates.KnockoutPartials)throw"Pollon Import Partial Command: unable to install this command. KnockoutPartials plugin is missing";return a.Templates.KnockoutPartials.get(o,r[1]),!0},C=function(t){f(r,n);var e=d(r);function r(t){var n;return l(this,r),(n=e.call(this,"Pollon.ImportPartial",'import partial "([^"]+)" from "([^"]+)"',(function(){}))).strategy=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return b.apply(this,[t].concat(n))},n}return r}(),E=function(e,n){var r,o;if(n.shift(),2!=(r=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Navigate Command";if(!(o=t.get(r[0])))throw"Pollon Navigate Command: app ".concat(r[0]," does not exist");return o.navigate(r[1]),!0},S=function(t){f(n,o);var e=d(n);function n(t){var r;return l(this,n),(r=e.call(this,"Pollon.Navigate",'navigate to "(.*)"',(function(){}))).strategy=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return E.apply(this,[t].concat(n))},r}return n}(),j=function(){},x=function(t){for(var e,n,r,o,a,i=arguments.length,c=new Array(i>1?i-1:0),l=1;l<i;l++)c[l-1]=arguments[l];c.shift(),e=c.shift(),n=/(?:([a-zA-Z0-9 ]+) from ([a-zA-Z0-9 ]+) to ([a-zA-Z0-9 ]+))/;for(var u=(r=c.shift().split(",")).length,s=0;s<u;s++)if(!n.test(r[s]))throw"Command Syntax Error: Create Command";for(var f=0;f<u;f++)r[f]=n.exec(r[f]);return o={},r.forEach((function(t,e){o[t[2].trim()]||(o[t[2].trim()]={}),o[t[2].trim()][t[1].trim()]=t[3].trim()})),t[e]?(console.warn("There's already a state machine named "+e+". Skipping creation."),!0):(a=Object.keys(o),a=o[a[0]]?a[0]:null,t[e]={fsm:{initial:a,transitions:o}},!0)},A=function(t){f(r,n);var e=d(r);function r(t){var n;return l(this,r),(n=e.call(this,"Pollon.StateMachine.create",'create statemachine "([^"]+)" with (?:status|statuses) (.*)',j)).strategy=function(){var e;return x.apply(this,(e=[t]).concat.apply(e,arguments))},n}return r}(),k=function(){},O=function(t){for(var e,n,r,o=arguments.length,a=new Array(o>1?o-1:0),c=1;c<o;c++)a[c-1]=arguments[c];if(a.shift(),n=a.shift(),e=a.shift(),!Array.from(document.querySelectorAll(e)).length)return!0;if(!t[n])throw"Command Error: cannot install a non existent statemachine: `"+n+"`";return r=new i(t[n].fsm),[].forEach.call(document.querySelectorAll(e),(function(o){o["juice:fsm:".concat(n)]||(o["juice:fsm:".concat(n)]=r,t[n].selector=e)})),!0},R=function(e){f(o,n);var r=d(o);function o(e,n){var a;return l(this,o),a=r.call(this,"Pollon.StateMachine.install",'install statemachine "([^"]+)" on "([^"]+)"',k),t.get(e).getStateMachine=function(t,e){if(n[t]){var r=c(document).one(e);if(r.length>1)throw"Cannot get ".concat(t," state machine on selector ").concat(e,". Selector happened to be not unique");return r.get(0)&&r.get(0)["juice:fsm:".concat(t)]}},a.strategy=function(){var t;return O.apply(this,(t=[n]).concat.apply(t,arguments))},a}return o}(),T=function(){},I=function(t){for(var e,n,o,a,c,l,u=arguments.length,s=new Array(u>1?u-1:0),f=1;f<u;f++)s[f-1]=arguments[f];if(s.shift(),n=s.shift(),o=s.shift(),a=s.shift(),!(l=t[n]))throw new Error("There's no state machine named "+n+" yet. Make sure you have a create command declared before this one.");if(!l.selector)throw new Error("Invalid selector for the state machine named ".concat(n,"."));if(!document.querySelectorAll(l.selector).length)throw new Error("There's no element matching your \""+e+'" CSS selector.');e=l.selector,c=r(a);var h=document.querySelectorAll(e);return[].forEach.call(h,(function(t){t["juice:fsm:".concat(n)]&&t["juice:fsm:".concat(n)].on(i.EVENTS.ENTERED,o,(function(e,n){c.execute(a,t)}))})),!0},q=function(t){f(r,n);var e=d(r);function r(t){var n;return l(this,r),(n=e.call(this,"Pollon.StateMachine.listener",'when statemachine "([^"]+)" status is "([^"]+)" (.*)',T)).strategy=function(){var e;return I.apply(this,(e=[t]).concat.apply(e,arguments))},n}return r}(),_=function(){},z=function(t,e,n){var r=e.statemachine,o=t[r];if(!o)throw new Error("There's no state machine named "+r+" yet. Make sure you have a create command declared before this one.");if(!o.selector)throw new Error("Invalid selector for the state machine named ".concat(r,"."));var a=o.selector;if(!document.querySelectorAll(a).length)throw new Error("There's no element matching your \""+a+'" CSS selector.');[].forEach.call(a,(function(t){var n=t["juice:fsm:".concat(r)];n&&n.can(e.value)&&n.handle(e.value)}))},M=function(t){f(n,o);var e=d(n);function n(t){var r;return l(this,n),(r=e.call(this,"Pollon.StateMachine.transition",'do statemachine "([^"]+)" transition "([^"]+)"',_)).strategy=function(){var e;return z.apply(this,(e=[t]).concat.apply(e,arguments))},r}return s(n,[{key:"parse",value:function(t){return{statemachine:(t=y(h(n.prototype),"parse",this).call(this,t))[2].trim(),value:t[3].trim()}}}]),n}(),D=function(t){f(r,e);var n=d(r);function r(t,e,o){var a;l(this,r),(a=n.call(this,t)).extension=o||".juice";var i=e.Ruleset;i.addCommand(new g(t)),i.addCommand(new P(t)),i.addCommand(new C(t));var c={};return i.addCommand(new A(c)),i.addCommand(new R(t,c)),i.addCommand(new q(c)),i.addBehaviour(new M(c)),i.addBehaviour(new S(t)),a.juice=e,a}return s(r,[{key:"get",value:function(t){var e,n=this;return this.canParse(t)?(e=this.getInfo(t),this.cache.get(e.id)?Promise.resolve():y(h(r.prototype),"get",this).call(this,t).then((function(t){return n.juice.parse(t),n.cache.put(e.id,!0),t}))):Promise.reject("Pollon: [template:juice] ".concat(t," element is unparseable by the Juice loader"))}},{key:"onUnloadable",value:function(t,e,n){return y(h(r.prototype),"onUnloadable",this).call(this,t,e,n).then((function(t){return console.warn("Pollon: [template:juice] Juice template loader: ".concat(t)),""})).catch((function(t){return console.warn("Pollon: [template:juice] Juice template loader: ".concat(t)),""}))}}]),r}(),N={install:function(t,e){return t.load("@pollon/juice-lang").then((function(e){t.Templates.Juice=new D(t.name,e)}))}};export{N as JuiceLoader};
