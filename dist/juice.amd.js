/* @pollon/juice - v1.0.0
* https://github.com/pollon-js/juice#readme
* 2020 Francesco Lasaracina. Licensed ISC */
define(["exports","@pollon/pollon","@pollon/juice-lang","@pollon/message-broker","@pollon/state-machine","@pollon/light-dom"],(function(t,e,n,o,r,a){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function c(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function l(t,e,n){return e&&c(t.prototype,e),n&&c(t,n),t}function u(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&f(t,e)}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function f(t,e){return(f=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function h(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function m(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,o=s(t);if(e){var r=s(this).constructor;n=Reflect.construct(o,arguments,r)}else n=o.apply(this,arguments);return h(this,n)}}function d(t,e,n){return(d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var o=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=s(t)););return t}(t,e);if(o){var r=Object.getOwnPropertyDescriptor(o,e);return r.get?r.get.call(n):r.value}})(t,e,n||t)}var p=function(t,o){var r,a,i,c,l,u;if(o.shift(),2!=(r=o.shift().split(":")).length)throw"Command Syntax Error: Pollon Lifecycle Command";if(!(a=e.Application.get(r[0])))throw"Pollon Lifecycle Command: app ".concat(r[0]," does not exist");switch(i=o.shift()){case"initialized":c="moduleInitialized";break;case"loaded":c="moduleLoaded";break;case"ready":c="moduleReady";break;case"disposed":c="moduleDisposed"}return u=o.shift(),l=n.findBehaviour(u),a[c].subscribe((function(t,e){var n;e.module==r[1]&&("initialized"!=i&&(n=document.querySelector('[data-view="'.concat(e.module,'"]'))),l.execute(u,n))})),!0},y=function(t){u(n,t);var e=m(n);function n(t){var o;return i(this,n),(o=e.call(this,"Pollon.Lifecycle",'when module "([^"]+)" is (initialized|loaded|ready|disposed) (.*)',(function(){}))).strategy=function(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return p.apply(this,[t].concat(n))},o}return n}(n.Command),v=function(t,r){var a,i,c,l,u;if(r.shift(),2!=(a=r.shift().split(":")).length)throw"Command Syntax Error: Pollon Events Command";if(!(i=e.Application.get(a[0])))throw"Pollon Events Command: app ".concat(a[0]," does not exist");return u=r.shift(),l=n.findBehaviour(u),(c={})[a[1]]={method:function(t,e){var n;n=document.querySelector("[pollon-app]"),l.execute(u,n)},once:!1},i.Bus.add(new o.Subscriber(c)),!0},g=function(t){u(n,t);var e=m(n);function n(t){var o;return i(this,n),(o=e.call(this,"Pollon.Events",'when pollon emits "([^"]+)" (.*)',(function(){}))).strategy=function(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return v.apply(this,[t].concat(n))},o}return n}(n.Command),w=function(t,n){var o,r,a;if(n.shift(),!(r=n.shift()))throw"Pollon Import Partial Command: invalid partial name";if(2!=(o=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Import Partial Command";if(!(a=e.Application.get(o[0])))throw"Pollon Import Partial Command: app ".concat(o[0]," does not exist");if(!a.Templates.KnockoutPartials)throw"Pollon Import Partial Command: unable to install this command. KnockoutPartials plugin is missing";return a.Templates.KnockoutPartials.get(r,o[1]),!0},P=function(t){u(n,t);var e=m(n);function n(t){var o;return i(this,n),(o=e.call(this,"Pollon.ImportPartial",'import partial "([^"]+)" from "([^"]+)"',(function(){}))).strategy=function(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return w.apply(this,[t].concat(n))},o}return n}(n.Command),b=function(t,n){var o,r;if(n.shift(),2!=(o=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Navigate Command";if(!(r=e.Application.get(o[0])))throw"Pollon Navigate Command: app ".concat(o[0]," does not exist");return r.navigate(o[1]),!0},C=function(t){u(n,t);var e=m(n);function n(t){var o;return i(this,n),(o=e.call(this,"Pollon.Navigate",'navigate to "(.*)"',(function(){}))).strategy=function(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return b.apply(this,[t].concat(n))},o}return n}(n.Behaviour),S=function(){},E=function(t){for(var e,n,o,r,a,i=arguments.length,c=new Array(i>1?i-1:0),l=1;l<i;l++)c[l-1]=arguments[l];c.shift(),e=c.shift(),n=/(?:([a-zA-Z0-9 ]+) from ([a-zA-Z0-9 ]+) to ([a-zA-Z0-9 ]+))/;for(var u=(o=c.shift().split(",")).length,s=0;s<u;s++)if(!n.test(o[s]))throw"Command Syntax Error: Create Command";for(var f=0;f<u;f++)o[f]=n.exec(o[f]);return r={},o.forEach((function(t,e){r[t[2].trim()]||(r[t[2].trim()]={}),r[t[2].trim()][t[1].trim()]=t[3].trim()})),t[e]?(console.warn("There's already a state machine named "+e+". Skipping creation."),!0):(a=Object.keys(r),a=r[a[0]]?a[0]:null,t[e]={fsm:{initial:a,transitions:r}},!0)},j=function(t){u(n,t);var e=m(n);function n(t){var o;return i(this,n),(o=e.call(this,"Pollon.StateMachine.create",'create statemachine "([^"]+)" with (?:status|statuses) (.*)',S)).strategy=function(){var e;return E.apply(this,(e=[t]).concat.apply(e,arguments))},o}return n}(n.Command),A=function(){},x=function(t){for(var e,n,o,a=arguments.length,i=new Array(a>1?a-1:0),c=1;c<a;c++)i[c-1]=arguments[c];if(i.shift(),n=i.shift(),e=i.shift(),!Array.from(document.querySelectorAll(e)).length)return!0;if(!t[n])throw"Command Error: cannot install a non existent statemachine: `"+n+"`";return o=new r.StateMachine(t[n].fsm),[].forEach.call(document.querySelectorAll(e),(function(r){r["juice:fsm:".concat(n)]||(r["juice:fsm:".concat(n)]=o,t[n].selector=e)})),!0},O=function(t){u(o,t);var n=m(o);function o(t,r){var c;return i(this,o),c=n.call(this,"Pollon.StateMachine.install",'install statemachine "([^"]+)" on "([^"]+)"',A),e.Application.get(t).getStateMachine=function(t,e){if(r[t]){var n=a.Query(document).one(e);if(n.length>1)throw"Cannot get ".concat(t," state machine on selector ").concat(e,". Selector happened to be not unique");return n.get(0)&&n.get(0)["juice:fsm:".concat(t)]}},c.strategy=function(){var t;return x.apply(this,(t=[r]).concat.apply(t,arguments))},c}return o}(n.Command),k=function(){},T=function(t){for(var e,o,a,i,c,l,u=arguments.length,s=new Array(u>1?u-1:0),f=1;f<u;f++)s[f-1]=arguments[f];if(s.shift(),o=s.shift(),a=s.shift(),i=s.shift(),!(l=t[o]))throw new Error("There's no state machine named "+o+" yet. Make sure you have a create command declared before this one.");if(!l.selector)throw new Error("Invalid selector for the state machine named ".concat(o,"."));if(!document.querySelectorAll(l.selector).length)throw new Error("There's no element matching your \""+e+'" CSS selector.');e=l.selector,c=n.findBehaviour(i);var h=document.querySelectorAll(e);return[].forEach.call(h,(function(t){t["juice:fsm:".concat(o)]&&t["juice:fsm:".concat(o)].on(r.StateMachine.EVENTS.ENTERED,a,(function(e,n){c.execute(i,t)}))})),!0},R=function(t){u(n,t);var e=m(n);function n(t){var o;return i(this,n),(o=e.call(this,"Pollon.StateMachine.listener",'when statemachine "([^"]+)" status is "([^"]+)" (.*)',k)).strategy=function(){var e;return T.apply(this,(e=[t]).concat.apply(e,arguments))},o}return n}(n.Command),M=function(){},_=function(t,e,n){var o=e.statemachine,r=t[o];if(!r)throw new Error("There's no state machine named "+o+" yet. Make sure you have a create command declared before this one.");if(!r.selector)throw new Error("Invalid selector for the state machine named ".concat(o,"."));var a=r.selector;if(!document.querySelectorAll(a).length)throw new Error("There's no element matching your \""+a+'" CSS selector.');[].forEach.call(a,(function(t){var n=t["juice:fsm:".concat(o)];n&&n.can(e.value)&&n.handle(e.value)}))},I=function(t){u(n,t);var e=m(n);function n(t){var o;return i(this,n),(o=e.call(this,"Pollon.StateMachine.transition",'do statemachine "([^"]+)" transition "([^"]+)"',M)).strategy=function(){var e;return _.apply(this,(e=[t]).concat.apply(e,arguments))},o}return l(n,[{key:"parse",value:function(t){return{statemachine:(t=d(s(n.prototype),"parse",this).call(this,t))[2].trim(),value:t[3].trim()}}}]),n}(n.Behaviour),q=function(t){u(n,t);var e=m(n);function n(t,o,r){var a;i(this,n),(a=e.call(this,t)).extension=r||".juice";var c=o.Ruleset;c.addCommand(new y(t)),c.addCommand(new g(t)),c.addCommand(new P(t));var l={};return c.addCommand(new j(l)),c.addCommand(new O(t,l)),c.addCommand(new R(l)),c.addBehaviour(new I(l)),c.addBehaviour(new C(t)),a.juice=o,a}return l(n,[{key:"get",value:function(t){var e,o=this;return this.canParse(t)?(e=this.getInfo(t),this.cache.get(e.id)?Promise.resolve():d(s(n.prototype),"get",this).call(this,t).then((function(t){return o.juice.parse(t),o.cache.put(e.id,!0),t}))):Promise.reject("Pollon: [template:juice] ".concat(t," element is unparseable by the Juice loader"))}},{key:"onUnloadable",value:function(t,e,o){return d(s(n.prototype),"onUnloadable",this).call(this,t,e,o).then((function(t){return console.warn("Pollon: [template:juice] Juice template loader: ".concat(t)),""})).catch((function(t){return console.warn("Pollon: [template:juice] Juice template loader: ".concat(t)),""}))}}]),n}(e.TemplateLoader),B={install:function(t,e){return t.load("@pollon/juice-lang").then((function(e){t.Templates.Juice=new q(t.name,e)}))}};t.JuiceLoader=B,Object.defineProperty(t,"__esModule",{value:!0})}));
