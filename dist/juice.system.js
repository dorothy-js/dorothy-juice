/* @pollon/juice - v1.0.0
* https://github.com/pollon-js/juice#readme
* 2020 Francesco Lasaracina. Licensed ISC */
System.register(["@pollon/pollon","@pollon/juice-lang","@pollon/message-broker","@pollon/state-machine","@pollon/light-dom"],(function(t){"use strict";var e,n,o,r,a,i,c,l;return{setters:[function(t){e=t.Application,n=t.TemplateLoader},function(t){o=t.Command,r=t.findBehaviour,a=t.Behaviour},function(t){i=t.Subscriber},function(t){c=t.StateMachine},function(t){l=t.Query}],execute:function(){function u(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function f(t,e,n){return e&&s(t.prototype,e),n&&s(t,n),t}function h(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&d(t,e)}function m(t){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function d(t,e){return(d=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function p(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function y(t,e,n){return(y="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var o=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=m(t)););return t}(t,e);if(o){var r=Object.getOwnPropertyDescriptor(o,e);return r.get?r.get.call(n):r.value}})(t,e,n||t)}var v=function(t,n){var o,a,i,c,l,u;if(n.shift(),2!=(o=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Lifecycle Command";if(!(a=e.get(o[0])))throw"Pollon Lifecycle Command: app ".concat(o[0]," does not exist");switch(i=n.shift()){case"initialized":c="moduleInitialized";break;case"loaded":c="moduleLoaded";break;case"ready":c="moduleReady";break;case"disposed":c="moduleDisposed"}return u=n.shift(),l=r(u),a[c].subscribe((function(t,e){var n;e.module==o[1]&&("initialized"!=i&&(n=document.querySelector('[data-view="'.concat(e.module,'"]'))),l.execute(u,n))})),!0},g=function(t){function e(t){var n;return u(this,e),(n=p(this,m(e).call(this,"Pollon.Lifecycle",'when module "([^"]+)" is (initialized|loaded|ready|disposed) (.*)',(function(){})))).strategy=function(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return v.apply(this,[t].concat(n))},n}return h(e,t),e}(o),w=function(t,n){var o,a,c,l,u;if(n.shift(),2!=(o=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Events Command";if(!(a=e.get(o[0])))throw"Pollon Events Command: app ".concat(o[0]," does not exist");return u=n.shift(),l=r(u),(c={})[o[1]]={method:function(t,e){var n;n=document.querySelector("[pollon-app]"),l.execute(u,n)},once:!1},a.Bus.add(new i(c)),!0},P=function(t){function e(t){var n;return u(this,e),(n=p(this,m(e).call(this,"Pollon.Events",'when pollon emits "([^"]+)" (.*)',(function(){})))).strategy=function(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return w.apply(this,[t].concat(n))},n}return h(e,t),e}(o),b=function(t,n){var o,r,a;if(n.shift(),!(r=n.shift()))throw"Pollon Import Partial Command: invalid partial name";if(2!=(o=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Import Partial Command";if(!(a=e.get(o[0])))throw"Pollon Import Partial Command: app ".concat(o[0]," does not exist");if(!a.Templates.KnockoutPartials)throw"Pollon Import Partial Command: unable to install this command. KnockoutPartials plugin is missing";return a.Templates.KnockoutPartials.get(r,o[1]),!0},C=function(t){function e(t){var n;return u(this,e),(n=p(this,m(e).call(this,"Pollon.ImportPartial",'import partial "([^"]+)" from "([^"]+)"',(function(){})))).strategy=function(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return b.apply(this,[t].concat(n))},n}return h(e,t),e}(o),S=function(t,n){var o,r;if(n.shift(),2!=(o=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Navigate Command";if(!(r=e.get(o[0])))throw"Pollon Navigate Command: app ".concat(o[0]," does not exist");return r.navigate(o[1]),!0},E=function(t){function e(t){var n;return u(this,e),(n=p(this,m(e).call(this,"Pollon.Navigate",'navigate to "(.*)"',(function(){})))).strategy=function(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return S.apply(this,[t].concat(n))},n}return h(e,t),e}(a),j=function(){},x=function(t){for(var e,n,o,r,a,i=arguments.length,c=new Array(i>1?i-1:0),l=1;l<i;l++)c[l-1]=arguments[l];c.shift(),e=c.shift(),n=/(?:([a-zA-Z0-9 ]+) from ([a-zA-Z0-9 ]+) to ([a-zA-Z0-9 ]+))/;for(var u=(o=c.shift().split(",")).length,s=0;s<u;s++)if(!n.test(o[s]))throw"Command Syntax Error: Create Command";for(var f=0;f<u;f++)o[f]=n.exec(o[f]);return r={},o.forEach((function(t,e){r[t[2].trim()]||(r[t[2].trim()]={}),r[t[2].trim()][t[1].trim()]=t[3].trim()})),t[e]?(console.warn("There's already a state machine named "+e+". Skipping creation."),!0):(a=Object.keys(r),a=r[a[0]]?a[0]:null,t[e]={fsm:{initial:a,transitions:r}},!0)},A=function(t){function e(t){var n;return u(this,e),(n=p(this,m(e).call(this,"Pollon.StateMachine.create",'create statemachine "([^"]+)" with (?:status|statuses) (.*)',j))).strategy=function(){var e;return x.apply(this,(e=[t]).concat.apply(e,arguments))},n}return h(e,t),e}(o),k=function(){},O=function(t){for(var e,n,o,r=arguments.length,a=new Array(r>1?r-1:0),i=1;i<r;i++)a[i-1]=arguments[i];if(a.shift(),n=a.shift(),e=a.shift(),!Array.from(document.querySelectorAll(e)).length)return!0;if(!t[n])throw"Command Error: cannot install a non existent statemachine: `"+n+"`";return o=new c(t[n].fsm),[].forEach.call(document.querySelectorAll(e),(function(r){r["juice:fsm:".concat(n)]||(r["juice:fsm:".concat(n)]=o,t[n].selector=e)})),!0},T=function(t){function n(t,o){var r;return u(this,n),r=p(this,m(n).call(this,"Pollon.StateMachine.install",'install statemachine "([^"]+)" on "([^"]+)"',k)),e.get(t).getStateMachine=function(t,e){if(o[t]){var n=l(document).one(e);if(n.length>1)throw"Cannot get ".concat(t," state machine on selector ").concat(e,". Selector happened to be not unique");return n.get(0)&&n.get(0)["juice:fsm:".concat(t)]}},r.strategy=function(){var t;return O.apply(this,(t=[o]).concat.apply(t,arguments))},r}return h(n,t),n}(o),I=function(){},q=function(t){for(var e,n,o,a,i,l,u=arguments.length,s=new Array(u>1?u-1:0),f=1;f<u;f++)s[f-1]=arguments[f];if(s.shift(),n=s.shift(),o=s.shift(),a=s.shift(),!(l=t[n]))throw new Error("There's no state machine named "+n+" yet. Make sure you have a create command declared before this one.");if(!l.selector)throw new Error("Invalid selector for the state machine named ".concat(n,"."));if(!document.querySelectorAll(l.selector).length)throw new Error("There's no element matching your \""+e+'" CSS selector.');e=l.selector,i=r(a);var h=document.querySelectorAll(e);return[].forEach.call(h,(function(t){t["juice:fsm:".concat(n)]&&t["juice:fsm:".concat(n)].on(c.EVENTS.ENTERED,o,(function(e,n){i.execute(a,t)}))})),!0},M=function(t){function e(t){var n;return u(this,e),(n=p(this,m(e).call(this,"Pollon.StateMachine.listener",'when statemachine "([^"]+)" status is "([^"]+)" (.*)',I))).strategy=function(){var e;return q.apply(this,(e=[t]).concat.apply(e,arguments))},n}return h(e,t),e}(o),_=function(){},z=function(t,e,n){var o=e.statemachine,r=t[o];if(!r)throw new Error("There's no state machine named "+o+" yet. Make sure you have a create command declared before this one.");if(!r.selector)throw new Error("Invalid selector for the state machine named ".concat(o,"."));var a=r.selector;if(!document.querySelectorAll(a).length)throw new Error("There's no element matching your \""+a+'" CSS selector.');[].forEach.call(a,(function(t){var n=t["juice:fsm:".concat(o)];n&&n.can(e.value)&&n.handle(e.value)}))},R=function(t){function e(t){var n;return u(this,e),(n=p(this,m(e).call(this,"Pollon.StateMachine.transition",'do statemachine "([^"]+)" transition "([^"]+)"',_))).strategy=function(){var e;return z.apply(this,(e=[t]).concat.apply(e,arguments))},n}return h(e,t),f(e,[{key:"parse",value:function(t){return{statemachine:(t=y(m(e.prototype),"parse",this).call(this,t))[2].trim(),value:t[3].trim()}}}]),e}(a),L=function(t){function e(t,n,o){var r;u(this,e),(r=p(this,m(e).call(this,t))).extension=o||".juice";var a=n.Ruleset;a.addCommand(new g(t)),a.addCommand(new P(t)),a.addCommand(new C(t));var i={};return a.addCommand(new A(i)),a.addCommand(new T(t,i)),a.addCommand(new M(i)),a.addBehaviour(new R(i)),a.addBehaviour(new E(t)),r.juice=n,r}return h(e,t),f(e,[{key:"get",value:function(t){var n,o=this;return this.canParse(t)?(n=this.getInfo(t),this.cache.get(n.id)?Promise.resolve():y(m(e.prototype),"get",this).call(this,t).then((function(t){return o.juice.parse(t),o.cache.put(n.id,!0),t}))):Promise.reject("Pollon: [template:juice] ".concat(t," element is unparseable by the Juice loader"))}},{key:"onUnloadable",value:function(t,n,o){return y(m(e.prototype),"onUnloadable",this).call(this,t,n,o).then((function(t){return console.warn("Pollon: [template:juice] Juice template loader: ".concat(t)),""})).catch((function(t){return console.warn("Pollon: [template:juice] Juice template loader: ".concat(t)),""}))}}]),e}(n);t("JuiceLoader",{install:function(t,e){return t.load("@pollon/juice-lang").then((function(e){t.Templates.Juice=new L(t.name,e)}))}})}}}));
