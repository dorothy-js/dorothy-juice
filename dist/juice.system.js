/* @pollon/juice - v1.0.0
* https://github.com/pollon-js/juice#readme
* 2020 Francesco Lasaracina. Licensed ISC */
System.register(["@pollon/pollon","@pollon/juice-lang","@pollon/message-broker","@pollon/state-machine","@pollon/light-dom"],(function(t){"use strict";var e,n,r,o,a,i,c,l;return{setters:[function(t){e=t.Application,n=t.TemplateLoader},function(t){r=t.Command,o=t.findBehaviour,a=t.Behaviour},function(t){i=t.Subscriber},function(t){c=t.StateMachine},function(t){l=t.Query}],execute:function(){function u(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function f(t,e,n){return e&&s(t.prototype,e),n&&s(t,n),t}function h(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&d(t,e)}function m(t){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function d(t,e){return(d=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function p(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function y(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=m(t);if(e){var o=m(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return p(this,n)}}function v(t,e,n){return(v="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var r=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=m(t)););return t}(t,e);if(r){var o=Object.getOwnPropertyDescriptor(r,e);return o.get?o.get.call(n):o.value}})(t,e,n||t)}var g=function(t,n){var r,a,i,c,l,u;if(n.shift(),2!=(r=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Lifecycle Command";if(!(a=e.get(r[0])))throw"Pollon Lifecycle Command: app ".concat(r[0]," does not exist");switch(i=n.shift()){case"initialized":c="moduleInitialized";break;case"loaded":c="moduleLoaded";break;case"ready":c="moduleReady";break;case"disposed":c="moduleDisposed"}return u=n.shift(),l=o(u),a[c].subscribe((function(t,e){var n;e.module==r[1]&&("initialized"!=i&&(n=document.querySelector('[data-view="'.concat(e.module,'"]'))),l.execute(u,n))})),!0},w=function(t){h(n,t);var e=y(n);function n(t){var r;return u(this,n),(r=e.call(this,"Pollon.Lifecycle",'when module "([^"]+)" is (initialized|loaded|ready|disposed) (.*)',(function(){}))).strategy=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return g.apply(this,[t].concat(n))},r}return n}(r),P=function(t,n){var r,a,c,l,u;if(n.shift(),2!=(r=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Events Command";if(!(a=e.get(r[0])))throw"Pollon Events Command: app ".concat(r[0]," does not exist");return u=n.shift(),l=o(u),(c={})[r[1]]={method:function(t,e){var n;n=document.querySelector("[pollon-app]"),l.execute(u,n)},once:!1},a.Bus.add(new i(c)),!0},b=function(t){h(n,t);var e=y(n);function n(t){var r;return u(this,n),(r=e.call(this,"Pollon.Events",'when pollon emits "([^"]+)" (.*)',(function(){}))).strategy=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return P.apply(this,[t].concat(n))},r}return n}(r),C=function(t,n){var r,o,a;if(n.shift(),!(o=n.shift()))throw"Pollon Import Partial Command: invalid partial name";if(2!=(r=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Import Partial Command";if(!(a=e.get(r[0])))throw"Pollon Import Partial Command: app ".concat(r[0]," does not exist");if(!a.Templates.KnockoutPartials)throw"Pollon Import Partial Command: unable to install this command. KnockoutPartials plugin is missing";return a.Templates.KnockoutPartials.get(o,r[1]),!0},S=function(t){h(n,t);var e=y(n);function n(t){var r;return u(this,n),(r=e.call(this,"Pollon.ImportPartial",'import partial "([^"]+)" from "([^"]+)"',(function(){}))).strategy=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return C.apply(this,[t].concat(n))},r}return n}(r),E=function(t,n){var r,o;if(n.shift(),2!=(r=n.shift().split(":")).length)throw"Command Syntax Error: Pollon Navigate Command";if(!(o=e.get(r[0])))throw"Pollon Navigate Command: app ".concat(r[0]," does not exist");return o.navigate(r[1]),!0},j=function(t){h(n,t);var e=y(n);function n(t){var r;return u(this,n),(r=e.call(this,"Pollon.Navigate",'navigate to "(.*)"',(function(){}))).strategy=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return E.apply(this,[t].concat(n))},r}return n}(a),x=function(){},A=function(t){for(var e,n,r,o,a,i=arguments.length,c=new Array(i>1?i-1:0),l=1;l<i;l++)c[l-1]=arguments[l];c.shift(),e=c.shift(),n=/(?:([a-zA-Z0-9 ]+) from ([a-zA-Z0-9 ]+) to ([a-zA-Z0-9 ]+))/;for(var u=(r=c.shift().split(",")).length,s=0;s<u;s++)if(!n.test(r[s]))throw"Command Syntax Error: Create Command";for(var f=0;f<u;f++)r[f]=n.exec(r[f]);return o={},r.forEach((function(t,e){o[t[2].trim()]||(o[t[2].trim()]={}),o[t[2].trim()][t[1].trim()]=t[3].trim()})),t[e]?(console.warn("There's already a state machine named "+e+". Skipping creation."),!0):(a=Object.keys(o),a=o[a[0]]?a[0]:null,t[e]={fsm:{initial:a,transitions:o}},!0)},k=function(t){h(n,t);var e=y(n);function n(t){var r;return u(this,n),(r=e.call(this,"Pollon.StateMachine.create",'create statemachine "([^"]+)" with (?:status|statuses) (.*)',x)).strategy=function(){var e;return A.apply(this,(e=[t]).concat.apply(e,arguments))},r}return n}(r),O=function(){},T=function(t){for(var e,n,r,o=arguments.length,a=new Array(o>1?o-1:0),i=1;i<o;i++)a[i-1]=arguments[i];if(a.shift(),n=a.shift(),e=a.shift(),!Array.from(document.querySelectorAll(e)).length)return!0;if(!t[n])throw"Command Error: cannot install a non existent statemachine: `"+n+"`";return r=new c(t[n].fsm),[].forEach.call(document.querySelectorAll(e),(function(o){o["juice:fsm:".concat(n)]||(o["juice:fsm:".concat(n)]=r,t[n].selector=e)})),!0},R=function(t){h(r,t);var n=y(r);function r(t,o){var a;return u(this,r),a=n.call(this,"Pollon.StateMachine.install",'install statemachine "([^"]+)" on "([^"]+)"',O),e.get(t).getStateMachine=function(t,e){if(o[t]){var n=l(document).one(e);if(n.length>1)throw"Cannot get ".concat(t," state machine on selector ").concat(e,". Selector happened to be not unique");return n.get(0)&&n.get(0)["juice:fsm:".concat(t)]}},a.strategy=function(){var t;return T.apply(this,(t=[o]).concat.apply(t,arguments))},a}return r}(r),I=function(){},q=function(t){for(var e,n,r,a,i,l,u=arguments.length,s=new Array(u>1?u-1:0),f=1;f<u;f++)s[f-1]=arguments[f];if(s.shift(),n=s.shift(),r=s.shift(),a=s.shift(),!(l=t[n]))throw new Error("There's no state machine named "+n+" yet. Make sure you have a create command declared before this one.");if(!l.selector)throw new Error("Invalid selector for the state machine named ".concat(n,"."));if(!document.querySelectorAll(l.selector).length)throw new Error("There's no element matching your \""+e+'" CSS selector.');e=l.selector,i=o(a);var h=document.querySelectorAll(e);return[].forEach.call(h,(function(t){t["juice:fsm:".concat(n)]&&t["juice:fsm:".concat(n)].on(c.EVENTS.ENTERED,r,(function(e,n){i.execute(a,t)}))})),!0},M=function(t){h(n,t);var e=y(n);function n(t){var r;return u(this,n),(r=e.call(this,"Pollon.StateMachine.listener",'when statemachine "([^"]+)" status is "([^"]+)" (.*)',I)).strategy=function(){var e;return q.apply(this,(e=[t]).concat.apply(e,arguments))},r}return n}(r),_=function(){},z=function(t,e,n){var r=e.statemachine,o=t[r];if(!o)throw new Error("There's no state machine named "+r+" yet. Make sure you have a create command declared before this one.");if(!o.selector)throw new Error("Invalid selector for the state machine named ".concat(r,"."));var a=o.selector;if(!document.querySelectorAll(a).length)throw new Error("There's no element matching your \""+a+'" CSS selector.');[].forEach.call(a,(function(t){var n=t["juice:fsm:".concat(r)];n&&n.can(e.value)&&n.handle(e.value)}))},L=function(t){h(n,t);var e=y(n);function n(t){var r;return u(this,n),(r=e.call(this,"Pollon.StateMachine.transition",'do statemachine "([^"]+)" transition "([^"]+)"',_)).strategy=function(){var e;return z.apply(this,(e=[t]).concat.apply(e,arguments))},r}return f(n,[{key:"parse",value:function(t){return{statemachine:(t=v(m(n.prototype),"parse",this).call(this,t))[2].trim(),value:t[3].trim()}}}]),n}(a),B=function(t){h(n,t);var e=y(n);function n(t,r,o){var a;u(this,n),(a=e.call(this,t)).extension=o||".juice";var i=r.Ruleset;i.addCommand(new w(t)),i.addCommand(new b(t)),i.addCommand(new S(t));var c={};return i.addCommand(new k(c)),i.addCommand(new R(t,c)),i.addCommand(new M(c)),i.addBehaviour(new L(c)),i.addBehaviour(new j(t)),a.juice=r,a}return f(n,[{key:"get",value:function(t){var e,r=this;return this.canParse(t)?(e=this.getInfo(t),this.cache.get(e.id)?Promise.resolve():v(m(n.prototype),"get",this).call(this,t).then((function(t){return r.juice.parse(t),r.cache.put(e.id,!0),t}))):Promise.reject("Pollon: [template:juice] ".concat(t," element is unparseable by the Juice loader"))}},{key:"onUnloadable",value:function(t,e,r){return v(m(n.prototype),"onUnloadable",this).call(this,t,e,r).then((function(t){return console.warn("Pollon: [template:juice] Juice template loader: ".concat(t)),""})).catch((function(t){return console.warn("Pollon: [template:juice] Juice template loader: ".concat(t)),""}))}}]),n}(n);t("JuiceLoader",{install:function(t,e){return t.load("@pollon/juice-lang").then((function(e){t.Templates.Juice=new B(t.name,e)}))}})}}}));
